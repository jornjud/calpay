<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalPay Ultimate - ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Kanit ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å */
        body {
            font-family: 'Kanit', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Custom Styles & Utilities */
        .btn {
            @apply inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .btn-primary { @apply text-white bg-blue-600 hover:bg-blue-700 focus:ring-blue-500; }
        .btn-secondary { @apply text-slate-700 bg-slate-200 hover:bg-slate-300 focus:ring-slate-400; }
        .btn-danger { @apply text-white bg-red-600 hover:bg-red-700 focus:ring-red-500; }
        .btn-success { @apply text-white bg-green-600 hover:bg-green-700 focus:ring-green-500; }
        .input-field { @apply block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm; }
        .card { @apply bg-white p-5 sm:p-6 rounded-xl shadow-lg border border-slate-100; }
        .modal { @apply fixed inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300; }
        .modal-content { @apply bg-white p-6 rounded-lg shadow-xl w-full max-w-md transform transition-all duration-300 scale-95 opacity-0; }
        .modal.active .modal-content { @apply scale-100 opacity-100; }
        #loading-overlay { @apply fixed inset-0 bg-white bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-[100] transition-opacity; }
        .spinner { @apply w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin; }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö view mode toggle */
        #app-wrapper.mobile-view {
            max-width: 420px;
            margin: 1rem auto;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 8px solid #1a202c;
            overflow: hidden;
        }

        /* Hide scrollbar but allow scrolling */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden">
        <div class="flex flex-col items-center">
            <div class="spinner"></div>
            <p id="loading-text" class="mt-4 text-slate-600 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
        </div>
    </div>

    <!-- ===== AUTHENTICATION SECTION ===== -->
    <div id="auth-section">
        <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-100 to-sky-200 p-4">
            <div class="w-full max-w-md">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-slate-800">CalPay Ultimate üí∏</h1>
                    <p class="text-slate-600 mt-2">‡πÅ‡∏≠‡∏õ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏™‡∏∏‡∏î‡πÄ‡∏à‡πã‡∏á</p>
                </div>

                <!-- Login Form -->
                <div id="login-form" class="card">
                    <h2 class="text-2xl font-bold text-center text-slate-700 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                    <form id="login-form-element">
                        <div class="space-y-4">
                            <div>
                                <label for="login-email" class="block text-sm font-medium text-slate-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input type="email" id="login-email" required class="input-field mt-1" placeholder="you@example.com">
                            </div>
                            <div>
                                <label for="login-password" class="block text-sm font-medium text-slate-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <input type="password" id="login-password" required class="input-field mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="btn btn-primary w-full">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </div>
                    </form>
                    <p class="text-center text-sm text-slate-600 mt-6">
                        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <button id="show-register-btn" class="font-medium text-blue-600 hover:text-blue-500">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</button>
                    </p>
                </div>

                <!-- Register Form (hidden by default) -->
                <div id="register-form" class="card hidden">
                    <h2 class="text-2xl font-bold text-center text-slate-700 mb-6">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</h2>
                    <form id="register-form-element">
                        <div class="space-y-4">
                            <div>
                                <label for="register-email" class="block text-sm font-medium text-slate-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input type="email" id="register-email" required class="input-field mt-1" placeholder="you@example.com">
                            </div>
                            <div>
                                <label for="register-password" class="block text-sm font-medium text-slate-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <input type="password" id="register-password" required class="input-field mt-1" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£">
                            </div>
                             <div>
                                <label for="register-confirm-password" class="block text-sm font-medium text-slate-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <input type="password" id="register-confirm-password" required class="input-field mt-1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                        </div>
                        <div class="mt-6">
                            <button type="submit" class="btn btn-primary w-full">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
                        </div>
                    </form>
                    <p class="text-center text-sm text-slate-600 mt-6">
                        ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <button id="show-login-btn" class="font-medium text-blue-600 hover:text-blue-500">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MAIN APPLICATION SECTION ===== -->
    <div id="app-section" class="hidden">
        <div id="app-wrapper" class="transition-all duration-300">
            <!-- Header -->
            <header class="sticky top-0 bg-white/80 backdrop-blur-lg shadow-sm z-20">
                <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between items-center h-16">
                        <div class="flex items-center">
                             <i class="fa-solid fa-wallet text-2xl text-blue-600"></i>
                            <span class="ml-3 text-xl font-bold text-slate-800">CalPay Ultimate</span>
                        </div>
                        <div class="flex items-center gap-4">
                             <!-- View Mode Toggle -->
                             <div class="hidden md:flex items-center gap-2">
                                 <button id="desktop-view-btn" class="p-2 rounded-md bg-blue-100 text-blue-600" title="Desktop View"><i class="fa-solid fa-desktop"></i></button>
                                 <button id="mobile-view-btn" class="p-2 rounded-md" title="Mobile View"><i class="fa-solid fa-mobile-screen-button"></i></button>
                             </div>
                             <div class="text-right">
                                <p id="user-email-display" class="text-sm font-medium text-slate-700 truncate max-w-xs"></p>
                                <p class="text-xs text-slate-500">Online</p>
                             </div>
                             <button id="logout-btn" class="btn btn-secondary">
                                <i class="fa-solid fa-right-from-bracket mr-2"></i>
                                <span class="hidden sm:inline">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- Category Management -->
                        <section id="categories-section">
                            <div class="card">
                                <h2 class="text-2xl font-semibold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-folder-open mr-3 text-sky-500"></i>1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h2>
                                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                                    <input type="text" id="new-category-name" class="input-field flex-grow" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á, ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£">
                                    <input type="hidden" id="editing-category-id">
                                    <button id="add-category-btn" class="btn btn-primary w-full sm:w-auto"><i class="fa-solid fa-plus mr-2"></i><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span></button>
                                </div>
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-lg font-medium text-slate-600">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</h3>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="select-all-categories-checkbox" class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500 cursor-pointer">
                                        <label for="select-all-categories-checkbox" class="ml-2 text-sm text-slate-600 cursor-pointer">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å/‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                                    </div>
                                </div>
                                <div id="categories-list" class="space-y-3 max-h-96 overflow-y-auto no-scrollbar pr-2">
                                    <p class="text-slate-500 text-center py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...</p>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Expense Management -->
                        <section id="add-expense-form-section">
                            <div class="card">
                                <h2 class="text-2xl font-semibold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-file-pen mr-3 text-amber-500"></i>2. ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 mb-6 items-end">
                                    <div>
                                        <label for="expense-description" class="block text-sm font-medium text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</label>
                                        <input type="text" id="expense-description" class="input-field" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏´‡∏°‡∏≤ AIS ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô">
                                    </div>
                                    <div>
                                        <label for="expense-amount-monthly" class="block text-sm font-medium text-slate-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô):</label>
                                        <input type="number" id="expense-amount-monthly" class="input-field" placeholder="250" min="0">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="expense-category-dropdown" class="block text-sm font-medium text-slate-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:</label>
                                        <select id="expense-category-dropdown" class="input-field">
                                            <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
                                        </select>
                                    </div>
                                    <input type="hidden" id="editing-expense-id">
                                </div>
                                <button id="add-expense-item-btn" class="btn btn-primary w-full sm:w-auto"><i class="fa-solid fa-plus mr-2"></i><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></button>
                            </div>
                        </section>
                    </div>

                    <!-- Right Column -->
                    <div class="lg:col-span-1 space-y-8">
                        <!-- Summary -->
                        <section id="summary-section">
                            <div class="card">
                                <h2 class="text-2xl font-semibold text-slate-700 mb-4 flex items-center"><i class="fa-solid fa-coins mr-3 text-green-500"></i>3. ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</h2>
                                <p class="text-sm text-slate-500 mb-4">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ</p>
                                <div class="space-y-3 text-lg">
                                    <div class="flex justify-between items-center p-3 bg-sky-50 rounded-lg">
                                        <span class="text-sky-700 text-base">‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢):</span>
                                        <span id="total-daily-expense" class="font-bold text-sky-800">0.00 ‡∏ö.</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                        <span class="text-green-700 text-base">‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</span>
                                        <span id="total-monthly-expense" class="font-bold text-green-800">0.00 ‡∏ö.</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-emerald-50 rounded-lg">
                                        <span class="text-emerald-700 text-base">‡∏ï‡πà‡∏≠‡∏õ‡∏µ:</span>
                                        <span id="total-yearly-expense" class="font-bold text-emerald-800">0.00 ‡∏ö.</span>
                                    </div>
                                </div>
                                <div class="mt-6">
                                     <button id="generate-report-btn" class="btn btn-primary w-full text-lg py-3"><i class="fa-solid fa-file-invoice-dollar mr-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ</button>
                                </div>
                            </div>
                        </section>
                    </div>
                 </div>

                 <!-- Expense Items View (hidden by default) -->
                <section id="expenses-section" class="mt-8 hidden">
                    <div class="card">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h2 class="text-2xl font-semibold text-slate-700">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î: <span id="current-category-name" class="text-blue-600"></span></h2>
                            <button id="back-to-categories-btn" class="btn btn-secondary btn-sm"><i class="fa-solid fa-arrow-left mr-2"></i>‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
                        </div>
                        <div id="expense-items-list" class="space-y-3"></div>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    <!-- Report Modal -->
    <div id="report-modal" class="modal hidden">
        <div class="modal-content w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div id="report-content-wrapper" class="flex-grow overflow-hidden flex flex-col">
                <div class="flex justify-between items-start mb-4 flex-shrink-0">
                     <h1 class="report-title flex-grow text-center text-red-500 text-xl sm:text-2xl font-bold border-b-2 border-blue-500 pb-3">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ #‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏´‡∏°‡∏≤‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô</h1>
                     <button id="close-report-modal-btn" class="text-slate-400 hover:text-red-500 -mt-2 -mr-2"><i class="fa-solid fa-xmark fa-2x"></i></button>
                </div>
                <div id="report-content" class="flex-grow overflow-y-auto no-scrollbar p-1">
                    <!-- Report content will be injected here -->
                </div>
            </div>
             <div class="flex-shrink-0 flex flex-col sm:flex-row gap-3 justify-end mt-6 pt-4 border-t">
                <button id="print-report-btn" class="btn btn-secondary"><i class="fa-solid fa-print mr-2"></i>‡∏û‡∏¥‡∏°‡∏û‡πå / PDF</button>
                <button id="copy-report-btn" class="btn btn-primary"><i class="fa-solid fa-copy mr-2"></i>‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>
    
    <!-- Message Modal -->
    <div id="message-modal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <h3 id="message-modal-title" class="text-xl font-semibold mb-3">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
            <p id="message-modal-text" class="text-slate-700 mb-4"></p>
            <div class="text-right">
                <button id="message-modal-close-btn" class="btn btn-primary">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal hidden">
        <div class="modal-content max-w-sm">
            <h3 class="text-xl font-semibold text-slate-800 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h3>
            <p id="confirm-modal-text" class="text-slate-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="confirm-modal-cancel-btn" class="btn btn-secondary">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-modal-ok-btn" class="btn btn-danger">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Firebase Config ‡∏Ç‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏ô‡∏∞, ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Canvas ‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ
        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡∏£‡∏±‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ô‡∏∞
        const firebaseConfig = {
          apiKey: "AIzaSyDhb9ytLJVVrRCqGe2B3MHTCH7LENNE1KY", //‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ API Key ‡∏à‡∏£‡∏¥‡∏á
          authDomain: "calpay-38a9f.firebaseapp.com", //‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Auth Domain ‡∏à‡∏£‡∏¥‡∏á
          projectId: "calpay-38a9f", //‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Project ID ‡∏à‡∏£‡∏¥‡∏á
          storageBucket: "calpay-38a9f.appspot.com", //‡∏´‡∏£‡∏∑‡∏≠ calpay-38a9f.firebasestorage.app ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏µ‡πà‡πÉ‡∏ä‡πâ
          messagingSenderId: "822753439035", //‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ Sender ID ‡∏à‡∏£‡∏¥‡∏á
          appId: "1:822753439035:web:fa676facb3906b5bdc9b1e" //‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ App ID ‡∏à‡∏£‡∏¥‡∏á
        };
        
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, addDoc, doc, setDoc, deleteDoc, onSnapshot, 
            query, where, writeBatch, orderBy, Timestamp, getDocs
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global state
        let app, auth, db;
        let userId = null; 
        let localCategoriesCache = []; 
        let listeners = []; // Array to hold all active listeners
        let confirmResolver = null;

        // === DOM Elements ===
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        // Auth
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginFormElement = document.getElementById('login-form-element');
        const registerFormElement = document.getElementById('register-form-element');
        const showRegisterBtn = document.getElementById('show-register-btn');
        const showLoginBtn = document.getElementById('show-login-btn');
        
        // App
        const appSection = document.getElementById('app-section');
        const appWrapper = document.getElementById('app-wrapper');
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutBtn = document.getElementById('logout-btn');
        const desktopViewBtn = document.getElementById('desktop-view-btn');
        const mobileViewBtn = document.getElementById('mobile-view-btn');

        // Categories
        const newCategoryNameInput = document.getElementById('new-category-name');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const editingCategoryIdInput = document.getElementById('editing-category-id');
        const categoriesListDiv = document.getElementById('categories-list');
        const selectAllCategoriesCheckbox = document.getElementById('select-all-categories-checkbox');
        
        // Expenses
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountMonthlyInput = document.getElementById('expense-amount-monthly');
        const expenseCategoryDropdown = document.getElementById('expense-category-dropdown');
        const addExpenseItemBtn = document.getElementById('add-expense-item-btn');
        const editingExpenseIdInput = document.getElementById('editing-expense-id');

        // Views
        const categoriesSection = document.getElementById('categories-section');
        const addExpenseFormSection = document.getElementById('add-expense-form-section');
        const expensesSection = document.getElementById('expenses-section');
        const currentCategoryNameSpan = document.getElementById('current-category-name');
        const expenseItemsListDiv = document.getElementById('expense-items-list');
        const backToCategoriesBtn = document.getElementById('back-to-categories-btn');

        // Summary & Report
        const totalDailyExpenseSpan = document.getElementById('total-daily-expense'); 
        const totalMonthlyExpenseSpan = document.getElementById('total-monthly-expense');
        const totalYearlyExpenseSpan = document.getElementById('total-yearly-expense');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportModal = document.getElementById('report-modal');
        const closeReportModalBtn = document.getElementById('close-report-modal-btn');
        const reportContentDiv = document.getElementById('report-content');
        const printReportBtn = document.getElementById('print-report-btn');
        const copyReportBtn = document.getElementById('copy-report-btn');

        // Modals
        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalText = document.getElementById('message-modal-text');
        const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const confirmModalOkBtn = document.getElementById('confirm-modal-ok-btn');

        // === Utility Functions ===
        const showLoading = (show, text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') => {
            loadingText.textContent = text;
            loadingOverlay.classList.toggle('hidden', !show);
        };

        const showMessage = (title, text, type = 'info') => {
            messageModalTitle.textContent = title;
            messageModalText.innerHTML = text; 
            messageModalTitle.classList.toggle('text-red-600', type === 'error');
            messageModalTitle.classList.toggle('text-green-600', type === 'success');
            messageModalTitle.classList.toggle('text-blue-600', type === 'info');
            messageModal.classList.remove('hidden');
            setTimeout(() => messageModal.classList.add('active'), 10);
        };
        const hideMessage = () => {
            messageModal.classList.remove('active');
            setTimeout(() => messageModal.classList.add('hidden'), 300);
        };
        
        const showConfirm = (text) => {
            return new Promise((resolve) => {
                confirmResolver = resolve;
                confirmModalText.textContent = text;
                confirmModal.classList.remove('hidden');
                setTimeout(() => confirmModal.classList.add('active'), 10);
            });
        };
        const hideConfirm = () => {
            confirmModal.classList.remove('active');
            setTimeout(() => confirmModal.classList.add('hidden'), 300);
        };

        const formatCurrency = (amount, digits = 2) => {
            if (typeof amount !== 'number' || isNaN(amount)) return '0.00';
            return amount.toLocaleString('th-TH', {minimumFractionDigits: digits, maximumFractionDigits: digits});
        };

        // === Firebase Initialization & Auth Handling ===
        function initializeFirebaseApp() {
            try {
                const effectiveConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
                if (!effectiveConfig.apiKey || effectiveConfig.apiKey.startsWith("YOUR_")) {
                    showMessage("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "Firebase config ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô! ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡∏π‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Canvas ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏•‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏î‡∏π", "error");
                    return;
                }
                app = initializeApp(effectiveConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setupAuthListener();
            } catch (error) {
                console.error("Firebase Init Error:", error);
                showMessage("Firebase Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏à‡πâ‡∏≤: " + error.message, "error");
            }
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                detachAllListeners(); // Clear old listeners on auth state change
                if (user) {
                    // User is signed in
                    userId = user.uid;
                    userEmailDisplay.textContent = user.email || 'Anonymous User';
                    authSection.classList.add('hidden');
                    appSection.classList.remove('hidden');
                    showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...');
                    await initializeAppData();
                    showLoading(false);
                } else {
                    // User is signed out
                    userId = null;
                    localCategoriesCache = [];
                    appSection.classList.add('hidden');
                    authSection.classList.remove('hidden');
                    showLoading(false);
                }
            });
        }
        
        async function handleInitialAuth() {
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô...");
            try {
                // For Google's Canvas environment
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                }
            } catch (error) {
                console.log("No custom token found or error signing in, waiting for user login.", error.message);
            } finally {
                showLoading(false);
            }
        }

        function handleRegister(e) {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;

            if (password !== confirmPassword) {
                showMessage("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô!", "error");
                return;
            }
            if (password.length < 6) {
                showMessage("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ô‡∏∞", "error");
                return;
            }

            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ...");
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    showMessage("‡πÄ‡∏¢‡πâ!", `‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö ${userCredential.user.email}!`, "success");
                    // onAuthStateChanged will handle UI switching
                })
                .catch((error) => {
                    console.error("Register error:", error);
                    showMessage("‡πÇ‡∏≠‡πä‡∏∞‡πÇ‡∏≠...", "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏î‡∏π‡∏ô‡∏∞: " + error.message, "error");
                })
                .finally(() => showLoading(false));
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...");
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // onAuthStateChanged will handle everything
                })
                .catch((error) => {
                    console.error("Login error:", error);
                     showMessage("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ß‡πà‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏•‡∏≠‡∏á‡∏î‡∏π‡πÉ‡∏´‡∏°‡πà‡∏î‡∏¥‡πä", "error");
                })
                .finally(() => showLoading(false));
        }

        function handleLogout() {
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...");
            signOut(auth).catch((error) => {
                 showMessage("Error", "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Æ‡∏∞: " + error.message, "error");
            }).finally(() => showLoading(false));
        }

        // === App Data Initialization ===
        async function initializeAppData() {
            if (!userId) return;
            // Reset UI state for new user
            resetCategoryForm();
            resetExpenseForm();
            switchToMainView();
            // Load data
            await Promise.all([
                loadCategories(),
                loadAllExpensesForSummary()
            ]);
            renderSummary();
        }

        // === Listener Management ===
        function detachAllListeners() {
            listeners.forEach(unsubscribe => unsubscribe());
            listeners = [];
            console.log("All Firestore listeners detached.");
        }
        
        // === Firebase Path helpers ===
        const categoriesCollectionRef = () => collection(db, 'users', userId, 'categories');
        const categoryDocRef = (id) => doc(db, 'users', userId, 'categories', id);
        const expensesCollectionRef = () => collection(db, 'users', userId, 'expenses');
        const expenseDocRef = (id) => doc(db, 'users', userId, 'expenses', id);

        // === Category Management ===
        async function loadCategories() {
            if (!userId) return;
            const q = query(categoriesCollectionRef(), orderBy("name")); 
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const cats = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    cats.push({ id: doc.id, ...data, selectedForReport: data.selectedForReport !== false }); 
                });
                localCategoriesCache = cats.map(cat => ({ ...cat, expenses: localCategoriesCache.find(c => c.id === cat.id)?.expenses || [] }));
                renderCategories(cats);
                updateCategoryDropdown(cats);
                updateSelectAllCheckboxState(); 
                renderSummary(); 
            }, (error) => {
                console.error("Error loading categories:", error);
                showMessage("Error", `‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`, "error");
            });
            listeners.push(unsubscribe); // Add to listeners array
        }

        function renderCategories(categoriesData) {
            categoriesListDiv.innerHTML = '';
            if (categoriesData.length === 0) {
                categoriesListDiv.innerHTML = '<p class="text-slate-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏π‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏°‡∏∞!</p>';
                selectAllCategoriesCheckbox.checked = false;
                selectAllCategoriesCheckbox.disabled = true;
                return;
            }
            selectAllCategoriesCheckbox.disabled = false;
            categoriesData.forEach(category => {
                const div = document.createElement('div');
                div.className = 'category-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors duration-200 gap-2';
                
                const left = document.createElement('div');
                left.className = 'flex items-center flex-grow w-full sm:w-auto';
                left.innerHTML = `
                    <input type="checkbox" data-category-id="${category.id}" class="category-select-checkbox w-5 h-5 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500 cursor-pointer flex-shrink-0" ${category.selectedForReport ? 'checked' : ''}>
                    <span class="category-name ml-3 text-slate-700 font-medium cursor-pointer hover:text-blue-600 truncate">${category.name}</span>
                `;
                
                const right = document.createElement('div');
                right.className = 'flex space-x-2 flex-shrink-0 self-end sm:self-center';
                right.innerHTML = `
                    <button class="edit-category-btn btn btn-secondary btn-sm !p-2" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠"><i class="fa-solid fa-pencil"></i></button>
                    <button class="delete-category-btn btn btn-danger btn-sm !p-2" title="‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà"><i class="fa-solid fa-trash-can"></i></button>
                `;
                
                // Event Listeners
                left.querySelector('.category-select-checkbox').addEventListener('change', (e) => toggleCategoryReportSelection(category.id, e.target.checked));
                left.querySelector('.category-name').addEventListener('click', () => switchToExpenseView(category.id, category.name));
                right.querySelector('.edit-category-btn').addEventListener('click', () => startEditCategoryName(category));
                right.querySelector('.delete-category-btn').addEventListener('click', () => confirmDeleteCategory(category.id, category.name));
                
                div.appendChild(left);
                div.appendChild(right);
                categoriesListDiv.appendChild(div);
            });
        }
        
        function toggleCategoryReportSelection(categoryId, isSelected) {
            const category = localCategoriesCache.find(cat => cat.id === categoryId);
            if (category) {
                category.selectedForReport = isSelected;
            }
            updateSelectAllCheckboxState();
            renderSummary(); 
        }

        function updateSelectAllCheckboxState() {
            if (!selectAllCategoriesCheckbox) return;
            const totalCategories = localCategoriesCache.length;
            if (totalCategories === 0) return;
            
            const selectedCount = localCategoriesCache.filter(cat => cat.selectedForReport).length;
            if (selectedCount === 0) {
                selectAllCategoriesCheckbox.checked = false;
                selectAllCategoriesCheckbox.indeterminate = false;
            } else if (selectedCount === totalCategories) {
                selectAllCategoriesCheckbox.checked = true;
                selectAllCategoriesCheckbox.indeterminate = false;
            } else {
                selectAllCategoriesCheckbox.checked = false;
                selectAllCategoriesCheckbox.indeterminate = true;
            }
        }
        
        async function handleCategorySubmit() {
            const name = newCategoryNameInput.value.trim();
            const editingId = editingCategoryIdInput.value;
            if (!name) {
                showMessage("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô!", "error");
                return;
            }
            showLoading(true, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...");
            try {
                if (editingId) {
                    await setDoc(categoryDocRef(editingId), { name }, { merge: true });
                } else {
                    await addDoc(categoriesCollectionRef(), { name, createdAt: Timestamp.now(), selectedForReport: true });
                }
                resetCategoryForm();
            } catch (error) {
                showMessage("Error", `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`, "error");
            } finally {
                showLoading(false);
            }
        }
        
        function startEditCategoryName(category) {
            newCategoryNameInput.value = category.name;
            editingCategoryIdInput.value = category.id;
            addCategoryBtn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠</span>';
            addCategoryBtn.classList.replace('btn-primary', 'btn-success');
            newCategoryNameInput.focus();
        }

        function resetCategoryForm() {
            newCategoryNameInput.value = '';
            editingCategoryIdInput.value = '';
            addCategoryBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>';
            addCategoryBtn.classList.replace('btn-success', 'btn-primary');
        }

        async function confirmDeleteCategory(id, name) {
            const confirmed = await showConfirm(`‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}"? ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡πÄ‡∏ß‡πâ‡∏¢!`);
            if (confirmed) {
                showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
                try {
                    const batch = writeBatch(db);
                    // Delete category doc
                    batch.delete(categoryDocRef(id));
                    // Query and delete all expenses in this category
                    const q = query(expensesCollectionRef(), where("categoryId", "==", id));
                    const expensesSnapshot = await getDocs(q);
                    expensesSnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();

                    showMessage("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", `‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${name}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`, "success");
                    if (expensesSection.dataset.currentViewingCategoryId === id) {
                        switchToMainView(); 
                    }
                } catch (error) {
                    showMessage("Error", `‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`, "error");
                } finally {
                    showLoading(false);
                }
            }
        }

        function updateCategoryDropdown(categoriesData) {
            expenseCategoryDropdown.innerHTML = '<option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>';
            expenseCategoryDropdown.disabled = categoriesData.length === 0;
            categoriesData.forEach(c => {
                expenseCategoryDropdown.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        }
        
        // === Expense Management ===
        async function loadAllExpensesForSummary() {
            if (!userId) return;
            const q = query(expensesCollectionRef(), orderBy("createdAt", "desc"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const allUserExpenses = [];
                snapshot.forEach(doc => allUserExpenses.push({ id: doc.id, ...doc.data() }));
                localCategoriesCache.forEach(cat => {
                    cat.expenses = allUserExpenses.filter(exp => exp.categoryId === cat.id);
                });
                renderSummary();
            }, (error) => {
                console.error("Error loading all expenses:", error);
            });
            listeners.push(unsubscribe); // Add to listeners array
        }

        function loadExpensesForCategory(categoryId) {
            if (!userId) return;
            const q = query(expensesCollectionRef(), where("categoryId", "==", categoryId), orderBy("createdAt", "desc"));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const exps = [];
                snapshot.forEach(doc => exps.push({ id: doc.id, ...doc.data() }));
                renderExpenseItems(exps, categoryId);
            }, (error) => {
                console.error(`Error loading expenses for category ${categoryId}:`, error);
                expenseItemsListDiv.innerHTML = '<p class="text-red-500 text-center py-4">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
            });
            listeners.push(unsubscribe); // Add to listeners array
        }
        
        function renderExpenseItems(expensesData) {
            expenseItemsListDiv.innerHTML = '';
            if (expensesData.length === 0) {
                expenseItemsListDiv.innerHTML = '<p class="text-slate-500 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢</p>';
                return;
            }
            expensesData.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'expense-item flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 bg-sky-50 rounded-lg gap-3';
                const left = document.createElement('div');
                left.className = 'flex-grow';
                left.innerHTML = `
                    <p class="font-semibold text-slate-800">${expense.description}</p>
                    <p class="text-sm text-slate-500">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡∏∞: <span class="font-bold text-green-600">${formatCurrency(expense.monthlyAmount,0)} ‡∏ö.</span> | ‡∏õ‡∏µ‡∏•‡∏∞: <span class="font-bold text-emerald-700">${formatCurrency(expense.monthlyAmount * 12, 0)} ‡∏ö.</span></p>
                `;
                const right = document.createElement('div');
                right.className = 'flex space-x-2 flex-shrink-0 self-end sm:self-center';
                right.innerHTML = `
                    <button class="edit-expense-btn btn btn-secondary btn-sm !p-2" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fa-solid fa-pencil"></i></button>
                    <button class="delete-expense-btn btn btn-danger btn-sm !p-2" title="‡∏•‡∏ö"><i class="fa-solid fa-trash-can"></i></button>
                `;
                right.querySelector('.edit-expense-btn').addEventListener('click', () => {
                    switchToMainView();
                    startEditExpenseItem(expense);
                });
                right.querySelector('.delete-expense-btn').addEventListener('click', () => deleteExpenseItem(expense.id, expense.description));

                div.appendChild(left);
                div.appendChild(right);
                expenseItemsListDiv.appendChild(div);
            });
        }
        
        async function handleExpenseSubmit() {
            const description = expenseDescriptionInput.value.trim();
            const amountStr = expenseAmountMonthlyInput.value.trim();
            const categoryId = expenseCategoryDropdown.value;
            const editingId = editingExpenseIdInput.value;

            if (!description || !amountStr || !categoryId) {
                showMessage("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö", "‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô", "error");
                return;
            }
            const monthlyAmount = parseFloat(amountStr);
            if (isNaN(monthlyAmount) || monthlyAmount <= 0) {
                showMessage("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0", "error");
                return;
            }
            
            showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
            const data = { description, monthlyAmount, categoryId };
            try {
                if (editingId) {
                    data.lastUpdatedAt = Timestamp.now();
                    await setDoc(expenseDocRef(editingId), data, { merge: true });
                } else {
                    data.createdAt = Timestamp.now();
                    await addDoc(expensesCollectionRef(), data);
                }
                resetExpenseForm();
            } catch (error) {
                showMessage("Error", `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`, "error");
            } finally {
                showLoading(false);
            }
        }
        
        function startEditExpenseItem(expense) {
            expenseDescriptionInput.value = expense.description;
            expenseAmountMonthlyInput.value = expense.monthlyAmount;
            expenseCategoryDropdown.value = expense.categoryId;
            editingExpenseIdInput.value = expense.id;
            
            addExpenseItemBtn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</span>';
            addExpenseItemBtn.classList.replace('btn-primary', 'btn-success');
            
            addExpenseFormSection.scrollIntoView({ behavior: 'smooth' });
            expenseDescriptionInput.focus();
        }

        function resetExpenseForm() {
            expenseDescriptionInput.value = '';
            expenseAmountMonthlyInput.value = '';
            expenseCategoryDropdown.value = '';
            editingExpenseIdInput.value = '';
            addExpenseItemBtn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>';
            addExpenseItemBtn.classList.replace('btn-success', 'btn-primary');
        }

        async function deleteExpenseItem(id, name) {
            const confirmed = await showConfirm(`‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ "${name}"?`);
            if(confirmed) {
                showLoading(true, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
                try {
                    await deleteDoc(expenseDocRef(id));
                } catch(error) {
                    showMessage("Error", `‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ${error.message}`, "error");
                } finally {
                    showLoading(false);
                }
            }
        }

        // === View Switching ===
        function switchToExpenseView(categoryId, categoryName) {
            // Detach main page listeners to avoid conflicts
            detachAllListeners();
            // Load specific listeners for this view
            loadExpensesForCategory(categoryId);
            
            currentCategoryNameSpan.textContent = categoryName;
            expensesSection.dataset.currentViewingCategoryId = categoryId; 

            categoriesSection.classList.add('hidden');
            addExpenseFormSection.classList.add('hidden');
            document.querySelector('.lg\\:col-span-1').classList.add('hidden'); // Hide summary column
            document.querySelector('.lg\\:col-span-2').classList.replace('lg:col-span-2', 'lg:col-span-3'); // Expand main column
            expensesSection.classList.remove('hidden');
            expensesSection.scrollIntoView({ behavior: 'smooth' });
        }

        function switchToMainView() {
             // Detach view-specific listeners
            detachAllListeners();
            // Re-initialize main app listeners
            initializeAppData();

            expensesSection.classList.add('hidden');
            expensesSection.dataset.currentViewingCategoryId = '';

            categoriesSection.classList.remove('hidden');
            addExpenseFormSection.classList.remove('hidden');
            document.querySelector('.lg\\:col-span-1').classList.remove('hidden'); // Show summary column
            document.querySelector('.lg\\:col-span-3')?.classList.replace('lg:col-span-3', 'lg:col-span-2'); // Restore main column
            resetExpenseForm(); 
        }
        
        // === Summary & Report ===
        function renderSummary() {
            let totalMonthly = 0;
            localCategoriesCache.forEach(category => {
                if (category.selectedForReport && category.expenses) {
                    category.expenses.forEach(expense => {
                        totalMonthly += parseFloat(expense.monthlyAmount);
                    });
                }
            });
            const totalYearly = totalMonthly * 12;
            const totalDaily = totalMonthly / 30.4375; // More accurate average

            totalDailyExpenseSpan.textContent = `${formatCurrency(totalDaily)} ‡∏ö.`;
            totalMonthlyExpenseSpan.textContent = `${formatCurrency(totalMonthly)} ‡∏ö.`;
            totalYearlyExpenseSpan.textContent = `${formatCurrency(totalYearly)} ‡∏ö.`;
        }
        
        function generateReportContentText() {
            let text = "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ #‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏´‡∏°‡∏≤‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô\n============================\n\n";
            let grandTotal = 0;
            const selectedCats = localCategoriesCache.filter(c => c.selectedForReport);
            
            if (selectedCats.length === 0) return "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô";

            selectedCats.forEach(cat => {
                if (cat.expenses && cat.expenses.length > 0) {
                    text += `‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${cat.name}\n`;
                    let catTotal = 0;
                    cat.expenses.forEach(exp => {
                        text += `- ${exp.description}: ${formatCurrency(exp.monthlyAmount)} ‡∏ö./‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\n`;
                        catTotal += exp.monthlyAmount;
                    });
                    text += `  ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ: ${formatCurrency(catTotal)} ‡∏ö./‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\n\n`;
                    grandTotal += catTotal;
                }
            });
            
            if(grandTotal === 0) return "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏∞";

            text += `============================\n‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:\n`;
            text += `‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢): ${formatCurrency(grandTotal / 30.4375)} ‡∏ö.\n`;
            text += `‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ${formatCurrency(grandTotal)} ‡∏ö.\n`;
            text += `‡∏£‡∏≤‡∏¢‡∏õ‡∏µ: ${formatCurrency(grandTotal * 12)} ‡∏ö.\n`;
            text += "============================\n";
            text += "‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏î‡∏µ‡πÜ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏∑‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠! #COYG üî¥‚ö™\n";
            return text;
        }
        
        function generateReportContentHTML() {
            let html = `<p class="text-center text-slate-600 mb-4">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î! ‡∏î‡∏π‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏ù‡∏∏‡∏î‡πÜ #‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß üë®‚Äçüë©‚Äçüëß‚Äçüë¶‚ú®</p>`;
            html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
            let grandTotalMonthly = 0;
            const selectedCats = localCategoriesCache.filter(c => c.selectedForReport);
            let hasExpenses = false;
            
            if (selectedCats.length === 0) {
                 return `<p class="text-slate-500 text-center p-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏¥‡πä‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞</p>`;
            }

            selectedCats.forEach(category => {
                html += `<div class="category flex flex-col p-4 bg-slate-50 rounded-lg border">`;
                html += `<h2 class="report-category-title text-blue-600 font-bold text-lg border-b pb-2 mb-2">${category.name}</h2>`;
                let categoryTotal = 0;
                if (category.expenses && category.expenses.length > 0) {
                    hasExpenses = true;
                    html += '<div class="flex-grow space-y-2">';
                    category.expenses.forEach(expense => {
                         html += `<div class="category-item flex justify-between text-sm">
                                    <span class="item-name text-slate-700 truncate pr-2">${expense.description}</span>
                                    <span class="item-cost font-semibold text-green-600 whitespace-nowrap">${formatCurrency(expense.monthlyAmount,0)} ‡∏ö./‡∏î.</span>
                                 </div>`;
                        categoryTotal += expense.monthlyAmount;
                    });
                    html += '</div>';
                } else {
                    html += `<div class="flex-grow flex items-center justify-center"><p class="text-slate-400 italic text-sm">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>`;
                }
                html += `<div class="category-total mt-3 pt-3 border-t bg-blue-50 p-3 rounded-md text-right">
                            <p class="text-sm">‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ: <span class="font-bold text-blue-700 text-base">${formatCurrency(categoryTotal,0)} ‡∏ö./‡∏î.</span></p>
                            <p class="text-xs text-slate-500">‡∏ï‡πà‡∏≠‡∏õ‡∏µ: ${formatCurrency(categoryTotal * 12, 0)} ‡∏ö.</p>
                         </div>`;
                html += `</div>`;
                grandTotalMonthly += categoryTotal;
            });
            html += `</div>`;
            
            if (!hasExpenses) {
                return `<p class="text-slate-500 text-center p-8">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏•‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</p>`;
            }

            html += `<div class="grand-total-section mt-6 p-4 bg-slate-800 text-white rounded-lg text-center">
                        <h2 class="text-2xl font-bold text-red-400 mb-3">üö® ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ß‡πâ‡∏≤‡∏ß‡∏ã‡πà‡∏≤! üö®</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div><p class="text-slate-300">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô</p><p class="text-2xl font-bold">${formatCurrency(grandTotalMonthly/30.4375)} ‡∏ö.</p></div>
                            <div><p class="text-slate-300">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p><p class="text-2xl font-bold">${formatCurrency(grandTotalMonthly)} ‡∏ö.</p></div>
                            <div><p class="text-slate-300">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏õ‡∏µ</p><p class="text-2xl font-bold">${formatCurrency(grandTotalMonthly*12)} ‡∏ö.</p></div>
                        </div>
                     </div>`;
            html += `<p class="text-center text-xs text-slate-500 mt-4">‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏±‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏•‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡πâ‡∏≤‡∏ö! üòâ #‡∏™‡∏π‡πâ‡πÜ‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô #Arsenal‡∏™‡∏π‡πâ‡πÜ</p>`;
            return html;
        }

        function showReportModal() {
            reportContentDiv.innerHTML = generateReportContentHTML();
            reportModal.classList.remove('hidden');
            setTimeout(() => reportModal.classList.add('active'), 10);
        }

        function hideReportModal() {
            reportModal.classList.remove('active');
            setTimeout(() => reportModal.classList.add('hidden'), 300);
        }
        
        function printReport() {
            const content = generateReportContentHTML();
            const title = document.querySelector('#report-modal .report-title').textContent;
            const printWindow = window.open('', '', 'height=800,width=1200');
            printWindow.document.write('<html><head><title>' + title + '</title>');
            printWindow.document.write('<script src="https://cdn.tailwindcss.com"><\/script>');
            printWindow.document.write('<link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">');
            printWindow.document.write('<style>body { font-family: "Kanit", sans-serif; padding: 20px; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } .category, .grand-total-section { page-break-inside: avoid; }</style>');
            printWindow.document.write('</head><body >');
            printWindow.document.write('<h1 class="text-center text-2xl font-bold mb-4">' + title + '</h1>');
            printWindow.document.write(content);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            setTimeout(() => { // Timeout to allow content to render
                printWindow.focus();
                printWindow.print();
                printWindow.close();
            }, 500);
        }
        
        function copyReport() {
            const text = generateReportContentText();
            navigator.clipboard.writeText(text).then(() => {
                showMessage("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß!", "success");
            }).catch(err => {
                showMessage("Error", "‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏∞: " + err, "error");
            });
        }
        
        // === Event Listeners Setup ===
        function setupEventListeners() {
            // Auth
            showRegisterBtn.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            });
            showLoginBtn.addEventListener('click', () => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });
            loginFormElement.addEventListener('submit', handleLogin);
            registerFormElement.addEventListener('submit', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);
            
            // View Mode Toggle
            desktopViewBtn.addEventListener('click', () => {
                appWrapper.classList.remove('mobile-view');
                desktopViewBtn.classList.add('bg-blue-100', 'text-blue-600');
                mobileViewBtn.classList.remove('bg-blue-100', 'text-blue-600');
            });
            mobileViewBtn.addEventListener('click', () => {
                appWrapper.classList.add('mobile-view');
                mobileViewBtn.classList.add('bg-blue-100', 'text-blue-600');
                desktopViewBtn.classList.remove('bg-blue-100', 'text-blue-600');
            });
            
            // Categories
            addCategoryBtn.addEventListener('click', handleCategorySubmit);
            newCategoryNameInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleCategorySubmit());
            selectAllCategoriesCheckbox.addEventListener('change', (e) => {
                const isSelected = e.target.checked;
                localCategoriesCache.forEach(cat => cat.selectedForReport = isSelected);
                renderCategories(localCategoriesCache);
                renderSummary();
            });

            // Expenses
            addExpenseItemBtn.addEventListener('click', handleExpenseSubmit);
            
            // Views
            backToCategoriesBtn.addEventListener('click', switchToMainView);

            // Modals
            messageModalCloseBtn.addEventListener('click', hideMessage);
            reportModal.addEventListener('click', (e) => e.target === reportModal && hideReportModal());
            closeReportModalBtn.addEventListener('click', hideReportModal);
            printReportBtn.addEventListener('click', printReport);
            copyReportBtn.addEventListener('click', copyReport);
            generateReportBtn.addEventListener('click', showReportModal);

            // Confirm Modal
            confirmModalCancelBtn.addEventListener('click', () => {
                if (confirmResolver) confirmResolver(false);
                hideConfirm();
            });
            confirmModalOkBtn.addEventListener('click', () => {
                if (confirmResolver) confirmResolver(true);
                hideConfirm();
            });
        }
        
        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            initializeFirebaseApp();
            handleInitialAuth(); // Special handling for Canvas environment
        });
    </script>
</body>
</html>
